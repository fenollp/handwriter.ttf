mod io;
mod myrand;
mod nn;
mod raster;
mod tokenizer;
mod utils;
mod ziggurat_tables;

use harfbuzz_wasm::{debug, Font, Glyph, GlyphBuffer};
use wasm_bindgen::prelude::*;

#[wasm_bindgen]
pub unsafe fn shape(
    _shape_plan: u32,
    font_ref: u32,
    buf_ref: u32,
    _features: u32,
    _num_features: u32,
) -> i32 {
    utils::set_panic_hook();
    let font = Font::from_ref(font_ref);
    let mut buffer = GlyphBuffer::from_ref(buf_ref);
    let glyphs = &mut buffer.glyphs;
    let text = glyphs
        .iter()
        .map(|g| char::from_u32_unchecked(g.codepoint))
        .collect::<String>();
    if text.as_bytes()[0] != b'#' || text.len() == 1 {
        for g in glyphs {
            g.codepoint = font.get_glyph(g.codepoint, 0);
            g.x_advance = font.get_glyph_h_advance(g.codepoint);
        }
        return 1;
    }
    let scale = font.get_scale().0 / font.get_face().get_upem() as i32;
    debug(&format!("{:?} {}", &text[1..], scale));

    let res = nn::Generator::new().generate_for(&text.as_bytes()[1..]);
    let mut x_max = 0;
    let mut res = raster::rasterize_font(res, 20 * scale, 750 * scale, 0, 50 * scale)
        .into_iter()
        .map(|[x, y]| {
            x_max = x_max.max(x);
            Glyph {
                codepoint: font.get_glyph(0xF0001, 0),
                cluster: 0,
                x_advance: 0,
                y_advance: 0,
                x_offset: x,
                y_offset: y,
                flags: 0,
            }
        })
        .collect::<Vec<_>>();
    res.last_mut().unwrap().x_advance = x_max + 400 * scale;
    buffer.glyphs = res;
    1
}

#[test]
fn blblbl() {
    let text = "Oh boy!";
    dbg!(&text);
    let res = nn::Generator::new().generate_for(&text.as_bytes()[1..]);
    dbg!(&res);
    assert!(false);
}

/*
--- STDOUT:              synthesizer blblbl ---

running 1 test
test blblbl ... FAILED

failures:

failures:
    blblbl

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 2.29s


--- STDERR:              synthesizer blblbl ---
[src/lib.rs:63:5] &text = "Oh boy!"
[src/lib.rs:65:5] &res = [
    [
        0.7590980836521126,
        -0.28086041237836595,
        0.0,
    ],
    [
        1.6298399077701182,
        5.480002529137428,
        0.0,
    ],
    [
        0.7365340747834042,
        4.933330028442324,
        0.0,
    ],
    [
        -0.4330860313598377,
        6.153435925896488,
        0.0,
    ],
    [
        -1.422475577217603,
        7.005608896133191,
        0.0,
    ],
    [
        -2.487594079899041,
        7.162484841514529,
        0.0,
    ],
    [
        -2.873648917019451,
        7.185035861248536,
        0.0,
    ],
    [
        -3.5634957730271326,
        7.083882728124848,
        0.0,
    ],
    [
        -3.84110570845949,
        7.034110239588538,
        0.0,
    ],
    [
        -3.5773925478125257,
        7.165290296161908,
        0.0,
    ],
    [
        -3.8337697426342086,
        6.8110228233018315,
        0.0,
    ],
    [
        -3.6061179137104737,
        7.143178627817569,
        0.0,
    ],
    [
        -3.627327666327332,
        7.449554204639485,
        0.0,
    ],
    [
        -3.9920593994036526,
        7.292688982178584,
        0.0,
    ],
    [
        -2.981495452477918,
        7.743239400578704,
        0.0,
    ],
    [
        -3.2292739511759914,
        7.906426689221805,
        0.0,
    ],
    [
        -3.7147643928563925,
        7.547685394030844,
        0.0,
    ],
    [
        -3.1752247103858426,
        8.34010212627247,
        0.0,
    ],
    [
        -3.751307042451973,
        7.900343323306326,
        0.0,
    ],
    [
        -3.8662740838884773,
        9.00472198477553,
        0.0,
    ],
    [
        -3.9540343644817266,
        9.757752131587194,
        0.0,
    ],
    [
        -4.263395686530522,
        9.973170615963792,
        0.0,
    ],
    [
        -5.290844523318388,
        9.535434038657586,
        0.0,
    ],
    [
        -5.463951693184022,
        9.981863765395921,
        0.0,
    ],
    [
        -5.745045662868767,
        10.173561768905538,
        0.0,
    ],
    [
        -6.098736498361209,
        10.205500933996088,
        0.0,
    ],
    [
        -6.129389640709945,
        10.363633655932466,
        0.0,
    ],
    [
        -6.866859556816168,
        9.717978136156542,
        0.0,
    ],
    [
        -6.570448169860877,
        10.786937594994654,
        0.0,
    ],
    [
        -5.878212252035787,
        13.01620508373761,
        0.0,
    ],
    [
        -7.5741440456494065,
        10.861055998417102,
        0.0,
    ],
    [
        -7.75174198090685,
        12.539513643412302,
        0.0,
    ],
    [
        -8.526881050297817,
        12.229754995913362,
        0.0,
    ],
    [
        -7.785219570491503,
        14.789737398632942,
        0.0,
    ],
    [
        -8.205847612647734,
        13.812627349933004,
        0.0,
    ],
    [
        -8.870574296066401,
        14.593416528673176,
        0.0,
    ],
    [
        -9.432294432744541,
        14.226253084317113,
        0.0,
    ],
    [
        -9.641762793157541,
        14.515281088672593,
        0.0,
    ],
    [
        -9.505776367189469,
        16.04037086250922,
        0.0,
    ],
    [
        -10.117026885490253,
        15.341308312295935,
        0.0,
    ],
    [
        -9.225619530930633,
        16.60874637484032,
        0.0,
    ],
    [
        -9.839625850877626,
        16.34078086725352,
        0.0,
    ],
    [
        -9.58511389922958,
        18.651489201799222,
        0.0,
    ],
    [
        -10.441934669146121,
        17.493113070195946,
        0.0,
    ],
    [
        -10.4666129848812,
        18.18552830078905,
        0.0,
    ],
    [
        -10.62416464066074,
        18.415538261169626,
        0.0,
    ],
    [
        -10.740406520291975,
        18.202943015661837,
        0.0,
    ],
    [
        -10.074020747602894,
        20.719615914233565,
        0.0,
    ],
    [
        -10.713725476348388,
        20.390052471084886,
        0.0,
    ],
    [
        -10.12940866674749,
        21.315521498828023,
        0.0,
    ],
    [
        -11.288253616080361,
        20.756933619630974,
        0.0,
    ],
    [
        -11.248958831570055,
        22.397292535594644,
        0.0,
    ],
    [
        -11.419892995468803,
        22.8463711523551,
        0.0,
    ],
    [
        -11.38871013795976,
        23.468357930510106,
        0.0,
    ],
    [
        -10.625999060496005,
        23.846425588852917,
        0.0,
    ],
    [
        -11.660919431735659,
        23.119266383583124,
        0.0,
    ],
    [
        -11.92189175357137,
        22.595041290744604,
        0.0,
    ],
    [
        -11.368072323136055,
        24.105742522835396,
        0.0,
    ],
    [
        -10.75969553640887,
        25.780629880777838,
        0.0,
    ],
    [
        -11.758317676689094,
        25.089347409875124,
        0.0,
    ],
    [
        -12.49203312124818,
        23.726360680839228,
        0.0,
    ],
    [
        -11.740333859030855,
        26.135514044097054,
        0.0,
    ],
    [
        -11.71430770255283,
        25.91169482506632,
        0.0,
    ],
    [
        -12.270111637295193,
        26.06080472625184,
        0.0,
    ],
    [
        -12.632247740525774,
        25.464047974173216,
        0.0,
    ],
    [
        -12.352722438090183,
        27.146753758766465,
        0.0,
    ],
    [
        -12.368555069501287,
        27.357551440268924,
        0.0,
    ],
    [
        -13.124716081060322,
        26.66756808851427,
        0.0,
    ],
    [
        -13.085428608480866,
        27.153211756680193,
        0.0,
    ],
    [
        -12.896630910442559,
        27.72265009227826,
        0.0,
    ],
    [
        -13.487534676324833,
        27.368956887249684,
        0.0,
    ],
    [
        -14.23798980225242,
        27.23660016255234,
        0.0,
    ],
    [
        -14.77607951183568,
        26.491530544198362,
        0.0,
    ],
    [
        -13.793692455898992,
        28.884924708132324,
        0.0,
    ],
    [
        -14.483275358236797,
        28.30986766908781,
        0.0,
    ],
    [
        -13.887443427381395,
        30.461329759526016,
        0.0,
    ],
    [
        -14.70403549278134,
        29.10027464209217,
        0.0,
    ],
    [
        -13.6704182522016,
        32.84380299452761,
        0.0,
    ],
    [
        -13.198184487071453,
        35.289908162817774,
        0.0,
    ],
    [
        -13.04186193940253,
        37.2192843016521,
        0.0,
    ],
    [
        -12.508859685354885,
        37.10444487827139,
        0.0,
    ],
    [
        -11.773482172239767,
        40.1335413336159,
        0.0,
    ],
    [
        -11.35227320096821,
        40.5873663493462,
        0.0,
    ],
    [
        -12.05864366344478,
        39.60822561756519,
        0.0,
    ],
    [
        -11.133295483323156,
        41.53313927771926,
        0.0,
    ],
    [
        -11.967839278847002,
        40.55842716976474,
        0.0,
    ],
    [
        -11.737946811665427,
        41.446760206032586,
        0.0,
    ],
    [
        -12.106421527725166,
        41.585216204518666,
        0.0,
    ],
    [
        -11.567508376251006,
        42.90546421398288,
        0.0,
    ],
    [
        -11.719945071530722,
        43.17331123977167,
        0.0,
    ],
    [
        -11.72199310562776,
        44.333027573283886,
        0.0,
    ],
    [
        -11.442889718538757,
        44.227126102968235,
        0.0,
    ],
    [
        -11.996423781297356,
        44.184190101710186,
        0.0,
    ],
    [
        -12.077362486892701,
        44.26084950557513,
        0.0,
    ],
    [
        -11.540961291869785,
        45.76421472206442,
        0.0,
    ],
    [
        -12.2100815894315,
        44.97814660687546,
        0.0,
    ],
    [
        -12.922145983431456,
        44.80782217906774,
        0.0,
    ],
    [
        -12.13943237191361,
        46.75884999921341,
        0.0,
    ],
    [
        -12.86347532515559,
        46.426105799883004,
        0.0,
    ],
    [
        -13.35150497365011,
        46.66357479409193,
        0.0,
    ],
    [
        -14.081987491644629,
        46.22121147251826,
        0.0,
    ],
    [
        -14.009017302099563,
        46.52619388649559,
        0.0,
    ],
    [
        -13.579717001110652,
        49.46467495882278,
        0.0,
    ],
    [
        -14.483281833580824,
        47.928759206848255,
        0.0,
    ],
    [
        -14.244802527091302,
        49.015072029018405,
        0.0,
    ],
    [
        -14.12416037628192,
        49.36999353591798,
        0.0,
    ],
    [
        -14.30231457686887,
        49.37054137213926,
        0.0,
    ],
    [
        -14.754985646015973,
        49.54323031851884,
        0.0,
    ],
    [
        -14.38623865921226,
        51.17925458286572,
        0.0,
    ],
    [
        -15.180834098200505,
        49.63199732216423,
        0.0,
    ],
    [
        -15.672625557603398,
        50.09039067155406,
        0.0,
    ],
    [
        -15.866194591055875,
        50.845738142353895,
        0.0,
    ],
    [
        -15.500507493180393,
        51.710250067128726,
        0.0,
    ],
    [
        -15.626619810868721,
        52.34799658588845,
        0.0,
    ],
    [
        -16.675743201796564,
        51.41245076676411,
        0.0,
    ],
    [
        -15.867771350493186,
        52.89588171819565,
        0.0,
    ],
    [
        -16.83351356982577,
        51.81476031607045,
        0.0,
    ],
    [
        -16.290795932328393,
        53.53380400310559,
        0.0,
    ],
    [
        -16.71297088097049,
        53.40657301534095,
        0.0,
    ],
    [
        -17.348408022555958,
        53.132286437752434,
        0.0,
    ],
    [
        -16.83211545028974,
        54.96823756869995,
        0.0,
    ],
    [
        -17.525929795867523,
        54.302734709844906,
        0.0,
    ],
    [
        -18.04258938845771,
        53.69613154991101,
        0.0,
    ],
    [
        -18.076015758274146,
        54.9644445917578,
        0.0,
    ],
    [
        -18.072754496085587,
        55.17512721096598,
        0.0,
    ],
    [
        -17.77226952832622,
        55.64656130009024,
        0.0,
    ],
    [
        -17.88875331760455,
        56.05202234340959,
        0.0,
    ],
    [
        -18.434875983145673,
        56.095993268851316,
        0.0,
    ],
    [
        -18.853597977263476,
        55.972719948307365,
        0.0,
    ],
    [
        -18.93001507925205,
        56.25156217770699,
        0.0,
    ],
    [
        -18.084248077005874,
        57.345127838692775,
        0.0,
    ],
    [
        -17.40936002639658,
        59.73518961107409,
        0.0,
    ],
    [
        -18.846725953197456,
        57.12370502786442,
        0.0,
    ],
    [
        -18.229799754289225,
        58.95509160121152,
        0.0,
    ],
    [
        -18.487698512790317,
        59.33720631610009,
        0.0,
    ],
    [
        -18.657198696373136,
        59.44357914296784,
        0.0,
    ],
    [
        -19.216476957315784,
        59.264494713546604,
        0.0,
    ],
    [
        -18.94953167875527,
        59.950586393799334,
        0.0,
    ],
    [
        -19.54195147853703,
        59.31370674433919,
        0.0,
    ],
    [
        -20.003558594355777,
        59.263457015052225,
        0.0,
    ],
    [
        -19.799696048269627,
        60.50404914677094,
        0.0,
    ],
    [
        -19.234556325161673,
        60.60941863868422,
        0.0,
    ],
    [
        -19.374034464969256,
        61.062202360598064,
        0.0,
    ],
    [
        -20.03598422033577,
        60.61356466736402,
        0.0,
    ],
    [
        -20.001705360943475,
        61.438214283959574,
        0.0,
    ],
    [
        -20.283428665888586,
        61.363537927904986,
        0.0,
    ],
    [
        -20.866876968761623,
        61.53870332068513,
        0.0,
    ],
    [
        -20.812267550033074,
        62.77368727306295,
        0.0,
    ],
    [
        -21.307949902015963,
        62.515292408048325,
        0.0,
    ],
    [
        -21.247008669498918,
        63.62138649566454,
        0.0,
    ],
    [
        -21.59412834326118,
        63.81260878653445,
        0.0,
    ],
    [
        -21.347587772927405,
        64.63659507470489,
        0.0,
    ],
    [
        -22.116389417459562,
        63.49776903524884,
        0.0,
    ],
    [
        -22.07073142630707,
        64.71606149058616,
        0.0,
    ],
    [
        -22.4096875527078,
        64.23222715642773,
        0.0,
    ],
    [
        -22.157810209363063,
        65.63087174345664,
        0.0,
    ],
    [
        -22.652737808981513,
        65.57068192123651,
        0.0,
    ],
    [
        -22.67245623469485,
        66.10673814279971,
        0.0,
    ],
    [
        -23.44705810953662,
        65.93854035352099,
        0.0,
    ],
    [
        -23.58117771465188,
        66.33780365241853,
        0.0,
    ],
    [
        -22.401537082445614,
        68.93795419032097,
        0.0,
    ],
    [
        -23.72378900123544,
        66.71737364005696,
        0.0,
    ],
    [
        -23.529263030631455,
        67.77012195668506,
        0.0,
    ],
    [
        -23.664329515680585,
        66.60278555523331,
        0.0,
    ],
    [
        -23.97275323759586,
        67.1866591168828,
        0.0,
    ],
    [
        -24.04737711833784,
        67.41368508409667,
        0.0,
    ],
    [
        -24.06645336025235,
        68.05681958082442,
        0.0,
    ],
    [
        -24.597123889717,
        68.1722567758115,
        0.0,
    ],
    [
        -24.58630641209978,
        68.88245912607566,
        0.0,
    ],
    [
        -25.047201437674644,
        68.98033150384448,
        0.0,
    ],
    [
        -25.424227108709623,
        68.70952952322813,
        0.0,
    ],
    [
        -25.048015272865513,
        70.32442607788215,
        0.0,
    ],
    [
        -25.604844068155053,
        70.79585717021888,
        0.0,
    ],
    [
        -26.354595023556854,
        70.00200337166055,
        0.0,
    ],
    [
        -26.80231092923559,
        70.50676775295724,
        0.0,
    ],
    [
        -27.174379945746956,
        70.7768791033913,
        0.0,
    ],
    [
        -26.280858058337152,
        72.9520270612188,
        0.0,
    ],
    [
        -27.41407965502889,
        71.75897151605291,
        0.0,
    ],
    [
        -27.383303102131038,
        72.38803642751586,
        0.0,
    ],
    [
        -26.951076698850574,
        73.93110156922033,
        0.0,
    ],
    [
        -27.52829204544149,
        73.85855722054485,
        0.0,
    ],
    [
        -27.860733781526317,
        73.55443481588684,
        0.0,
    ],
    [
        -27.787095069996248,
        74.31654764036217,
        0.0,
    ],
    [
        -28.64038537818834,
        74.24093879205006,
        0.0,
    ],
    [
        -28.435109307396274,
        74.76320220000902,
        0.0,
    ],
    [
        -28.680969383524904,
        75.00229250418234,
        0.0,
    ],
    [
        -29.20603032662106,
        75.02954378174854,
        0.0,
    ],
    [
        -29.327812483850224,
        75.73262192358129,
        0.0,
    ],
    [
        -29.378975030550812,
        76.01705461598151,
        0.0,
    ],
    [
        -28.252975670280442,
        76.49269970599362,
        0.0,
    ],
    [
        -29.16805834698494,
        76.87285278727089,
        0.0,
    ],
    [
        -30.185975523929624,
        75.7523606840502,
        0.0,
    ],
    [
        -30.057812056180463,
        76.65747974347083,
        0.0,
    ],
    [
        -31.35528462449924,
        76.10559660691433,
        0.0,
    ],
    [
        -30.841710969588313,
        77.6782341436647,
        0.0,
    ],
    [
        -31.79428549596735,
        77.23194902881674,
        0.0,
    ],
    [
        -30.987744951969596,
        78.79601263199507,
        0.0,
    ],
    [
        -31.688005408840482,
        78.3409101159751,
        0.0,
    ],
    [
        -31.722110285295123,
        79.01505192559175,
        0.0,
    ],
    [
        -32.10915706041626,
        78.93728015963937,
        0.0,
    ],
    [
        -32.45663478084361,
        79.18153952678603,
        0.0,
    ],
    [
        -32.51251296172701,
        79.89228846443382,
        0.0,
    ],
    [
        -32.536523509993046,
        80.38987444403762,
        0.0,
    ],
    [
        -33.60639827375485,
        80.05635390032518,
        0.0,
    ],
    [
        -33.8188453355478,
        80.61441744007455,
        0.0,
    ],
    [
        -33.460532732558576,
        82.37441489072204,
        0.0,
    ],
    [
        -34.37626574964442,
        81.60469101416902,
        0.0,
    ],
    [
        -35.04184760133577,
        81.20318272414609,
        0.0,
    ],
    [
        -34.86961155939481,
        82.02319577402146,
        0.0,
    ],
    [
        -34.94272712735704,
        82.60257769669732,
        0.0,
    ],
]
thread 'blblbl' panicked at src/lib.rs:66:5:
assertion failed: false
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

   Canceling due to test failure
------------
     Summary [   2.294s] 1 test run: 0 passed, 1 failed, 0 skipped
        FAIL [   2.293s] synthesizer blblbl
error: test run failed
100 3s synthesizer master λ

*/
